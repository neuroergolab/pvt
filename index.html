<!DOCTYPE html>

<html xmlns="https://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">

<head>

    <link type="text/css" rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Google+Sans:400,500,700|Google+Sans+Text:400">
    <link type="text/css" rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Google+Sans+Text:400&amp;text=%E2%86%90%E2%86%92%E2%86%91%E2%86%93">

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <style type="text/css">
        html,
        body {
            height: 100%;
        }
    </style>

    <meta charset="utf-8">
    <title>PVT </title>

    <meta name="description" content="TBU" />
    <meta name="viewport" content="width=1000, initial-scale=1.0, maximum-scale=1.0">
    <script type="text/javascript" src="warpspeed.min.js"></script>

    <link rel="shortcut icon" href="uwmadison.ico">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="myStyleSheet.css" rel="stylesheet">

</head>

<div style="position:fixed; z-index:1; top:0; left:0; width:100%; height:100%; overflow:auto;">

    <div id="theHead"> Psychomotor Vigilance Test (PVT)
        <br>
        <br>
        <p style="color: white; font-size: 20px; margin-left: 300px; margin-right: 300px;"> The PVT will start as soon as BEGIN is pressed. A <span style="color:red">RED</span> dot will appear in the center of the screen at random. Please press the SPACEBAR button as soon as you see the <span style="color:red">RED</span> dot. Please perform the task until it ends. A CSV file with your response data will be automatically downloaded when the task is complete.</p>
        <br>
</div>

    <form id="input_form" class="container" autocomplete="off">

        <label for="inp" class="inp">
            <input type="text" id="inp" placeholder="&nbsp;">
            <span class="label">Participant ID</span>
            <span class="focus-bg"></span>
        </label>

        <label for="duration-input" class="inp" style="top: 50%;">
            <input type="number" id="duration-input" placeholder="&nbsp;" value="5" min="1" max="60">
            <span class="label">Task Duration (minutes)</span>
            <span class="focus-bg"></span>
        </label>

        <a onclick="beginSequence();displaycircle()" class="simpleButton" id="beginBtn" style="top: 75%;"
            onmouseover="this.style.color = 'grey'" onmouseout="this.style.color = 'white'"> &lt; begin &gt; </a>
    </form>

    <div id="credits" style="color:#FFFFFF; text-align: center;">
        <br>
        Developed by <a href="https://www.rohithkarthikeyan.com" target="_blank"> Rohith Karthikeyan</a>,
        rohithkarthikeyan[at]tamu[dot]edu <br>
        The NeuroErgonomics Laboratory, Texas A&M University <br>
        <br>
        Star field effect inspired by <a href="https://fdossena.com/?p=about.frag" target="_blank"> Federico
            Dossena </a> and <a href="https://www.youtube.com/channel/UCvjgXvBlbQiydffZU7m1_aw" target="_blank"> The
            Coding Train</a> <br> <br>
    </div>

    <div id="backBtn" onmouseover="this.style.color = 'yellow'" onmouseout="this.style.color = 'white'"
        onclick="goBack()">
        Back</div>

    <div id="subjectiveForm" class="responseContainer"
        style="display: none; text-align: left; margin-left: auto; margin-right: auto;">

        <div class="row">
            <h4 style="color: tan;"> Refresh the page </h4>
            <div class="col-xs-12">
            </div>
        </div>

    </div>
    
    <div id="thanks" style="color:#FFFFFF; text-align: center; display: none;">
        <h2 style="color:tan">Experiment completed!</h2>
        <p style="text-align: center;">
            Thank you for participating in our study <br>
        </p>
    </div>

	<span id="circle" 
		style='display: none; color:#FF0000; font-size:100px; text-align: center; margin-top:20%;'>&#128308</span>
    <span id="timer"
        style="display: none; color:#FFFFFF; text-align: center; margin-top:20%; font-family: Roboto; font-size: 2em;"></span>
    <p id="block-intro"
        style="display: none; color:#FFFFFF; text-align: center; margin-top:20%; font-family: Roboto; font-size: 2em;">
    </p>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script>

// PVT Member Functions
pvt_member_functions = function () {

    var PVTFlag = false;
    var PVT_active = false;
    var terminatePVTFlag = false;
    var shouldHandleKeyDown = true;
    var resolvePVT = false;
    var elapsedTime;
    var timerUpdater;
    var pvt_start_time;
    var pvt_elapsed_time;
    var pvtDurationMinutes = 5;
    var pvtBlockDuration = pvtDurationMinutes * 60 * 1000;

    function PVT_instance() {
        console.log('pvt-instance');
        PVT_active = true;

        var instanceStartTime = Date.now();
        pvt_elapsed_time = instanceStartTime - pvt_start_time;

        if (pvt_elapsed_time > pvtBlockDuration) {
            terminatePVTFlag = true;
        }

        document.getElementById("timer").style.display = "none";
		document.getElementById("circle").style.display = "block";

        // alert pvt start w/countdown
        timerUpdater = setInterval(function () {
            elapsedTime = Date.now() - instanceStartTime;
            document.getElementById("timer").innerHTML = elapsedTime;
        }, 1);
    }

    document.body.onkeyup = function () {
        shouldHandleKeyDown = true;
    }

    document.body.onkeypress = function (e) {

        if (shouldHandleKeyDown) {
            shouldHandleKeyDown = false;

            if ((e.key === ' ' && PVT_active === true) || (e.type === 'touchstart' && PVT_active === true)) {
                if (terminatePVTFlag) {
                    console.log('terminating-PVT');
                    clearInterval(timerUpdater);
                    // save data from participantData to csv
                    save_csv();


                    setTimeout(function () {
						document.getElementById("circle").style.display = "none";
                        document.getElementById("timer").style.display = "none";
                        send_data_to_server('1', '1', elapsedTime);
                        elapsedTime = 0;
                        PVTFlag = false;
                        PVT_active = false;
                        timeVal = 4;
                        terminatePVTFlag = false;
                        resolvePVT = true;
                    });

                } else if (PVT_active === true && !terminatePVTFlag) {
                    PVT_active = false;
                    console.log('keypress-pvt');
                    clearInterval(timerUpdater);
                    setTimeout(function () {
						document.getElementById("circle").style.display = "none";
                        document.getElementById("timer").style.display = "none";
                        send_data_to_server('1', '1', elapsedTime);
                        elapsedTime = 0;
                        PVTRandomizer();
                    });

                } else {
                    console.log('pvt-patience!');
                    send_data_to_server('0', '0', 'NA');
                }


            };
        }
    }

    function PVT_terminate_condition_check() {
        console.log('pvt-terminate-condition-check');
        var d2 = $.Deferred();
        PVTBlock();
        pvtEndTracker = setInterval(function () {
            if (resolvePVT) {
                d2.resolve();
                resolvePVT = false;
                clearInterval(pvtEndTracker);
                return d2.promise();
            }
        }, 1);
        return d2.promise();

    }

    function PVTRandomizer() {
        console.log('pvt-randomizer');
        if (!PVT_active) {
            var max = 5;
            var min = 2;
            var rand = Math.floor(Math.random() * (max - min + 1) + min);
            setTimeout(PVT_instance, rand * 1000);
        }
    }

    function PVTBlock() {
        console.log('pvt-block');
        
        // Get duration from text input
        pvtDurationMinutes = parseInt(document.getElementById('duration-input').value);
        if (isNaN(pvtDurationMinutes) || pvtDurationMinutes < 1) {
            pvtDurationMinutes = 5; // Default to 5 if invalid
        }
        pvtBlockDuration = pvtDurationMinutes * 60 * 1000;
        
        var timeVal = 4;
        document.getElementById("input_form").style.display = "none";
        document.getElementById("subjectiveForm").style.display = "none";
        document.getElementById("theHead").style.display = "none";
        PVTFlag = true;

        // PVT intro blurb goes here
        var pvt_intro = setInterval(function () {

            document.getElementById("block-intro").style.display = "block";
            timeVal = timeVal - 1;
            document.getElementById("block-intro").innerHTML = "< PVT begins in " + timeVal + ' >';
            if (timeVal == 0) {

                pvt_start_time = Date.now();
                document.getElementById("block-intro").style.display = "none";
				document.getElementById("circle").style.display = "none";
                PVTRandomizer();
                clearInterval(pvt_intro);

            }
        }, 1000);

    }

    function save_csv() {
        console.log('save-csv');
        // save data from participantData to csv
        const csvData = Object.values(participantData).join('\n');
        const blob = new Blob([csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'pvt_' + document.getElementById('inp').value + '_' + Date.now() + '.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }


    // Global variable to store the CSV data for each participant ID
    const participantData = {};
    function send_data_to_server(rstate, rstate_legacy, rdelay) {

        try {
            var act = document.getElementById('standard-select').value;
        } catch {
            act = "NA";
        }

        // Get current unix timestamp in milliseconds
        var unixTimestamp = Date.now();
        
        // Get high-precision timestamp (ISO 8601 format with milliseconds)
        var preciseTimestamp = new Date().toISOString();

        // Construct form elements into Application/JSON template
        const data = {
            participantId: document.getElementById('inp').value,
            activity: act,
            unixTimestamp: unixTimestamp,
            responseTimeStamp: preciseTimestamp,
            responseState: rstate,
            responseDelay: rdelay
        };

        // Check if the CSV data for the current participant ID already exists
        if (data.participantId in participantData) {
            // Append the new data to the existing CSV data
            participantData[data.participantId] += '\n' + Object.values(data).join(',');
        } else {
            // Create a new CSV data for the current participant ID
            participantData[data.participantId] = Object.keys(data).join(',') + '\n' + Object.values(data).join(',');
        }

        return;
    }

      
    return {
        init: PVTBlock,
        setup: PVT_terminate_condition_check
    }
}();

// UI Functions

var showCredits = function () {
    console.log('show-credits');
    document.getElementById("creditBtn").style.display = "none";
    document.getElementById("input_form").style.display = "none";
    document.getElementById("credits").style.display = "block";
    document.getElementById("backBtn").style.display = "block";
}

function continueInterface(next_up) {
    var d = $.Deferred();
    console.log('continue-interface');
    document.getElementById("input_form").style.display = "none";
    document.getElementById("subjectiveForm").style.display = "block";
    document.getElementById("theHead").style.display = "none";
    d.resolve();
    return d.promise();
}

function displaycircle() {
    console.log('display-circle');
    document.getElementById("circle").style.display = "none";
}

function waitForSubmission() {
    console.log('wait-for-submission');
    var d = $.Deferred();
    document.getElementById("continueBtn").onclick = function () {
        submitSubjectiveResponse();
        d.resolve();
    }
    return d.promise();
}

function goBack() {
    console.log('go-back');
    document.getElementById("input_form").style.display = "block";
    document.getElementById("credits").style.display = "none";
    document.getElementById("creditBtn").style.display = "block";
    document.getElementById("backBtn").style.display = "none";
}

function submitSubjectiveResponse() {
    console.log('submit-subjective-response');
    subjectiveResponseSubmissionTime = Date().toLocaleString();
    var usrSelect = document.getElementById("standard-select");
    // Construct form elements into Application/JSON template
    const data = {
        participantId: document.getElementById('inp').value,
        activity: usrSelect.value,
        subjectiveResponseSubmissionTime: subjectiveResponseSubmissionTime,
        effort: $("input[type='radio'][name='effort']:checked").val(),
        fatigue: $("input[type='radio'][name='fatigue']:checked").val(),
        motivation: $("input[type='radio'][name='motivation']:checked").val(),
        workload: $("input[type='radio'][name='workload']:checked").val()
    };

    // Send form response (sheet monkey)
    fetch('https://api.sheetmonkey.io/form/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    }).then((result) => {
        // Handle the result
        console.log('subjective-response-submitted')
    });

    //reset pesky buttons
    $('input[name="effort"]').attr('checked', false);
    $('input[name="fatigue"]').attr('checked', false);
    $('input[name="motivation"]').attr('checked', false);
    $('input[name="workload"]').attr('checked', false);

    return;
}

function beginSequence() {
    console.log('begin-sequence');
    // clear display
    document.getElementById("input_form").style.display = "none";
    document.getElementById("theHead").style.display = "none";

    continueInterface().
    pipe(pvt_member_functions.setup).pipe(doNothingBuffer)
    .pipe(continueInterface)
    .pipe(completionStatus).pipe(returnHome);
}

function instructions_pvt() {
    console.log('instructions-pvt');
    var d = $.Deferred();
    document.getElementById("input_form").style.display = "none";
    document.getElementById("instructions-pvt").style.display = "block";
    document.getElementById("subjectiveForm").style.display = "none";
    d.resolve();
    return d.promise();

}

function instructions_two_back() {
    console.log('instructions-2-back');
    var d = $.Deferred();
    document.getElementById("input_form").style.display = "none";
    document.getElementById("instructions-2-back").style.display = "block";
    document.getElementById("subjectiveForm").style.display = "none";
    d.resolve();
    return d.promise();

}

function waitForProceedPVT() {
    console.log('wait-for-proceed-pvt');
    var d = $.Deferred();
    document.getElementById("proceedPVTBtn").onclick = function () {
        document.getElementById('instructions-pvt').style.display = "none";
        d.resolve();
    }
    return d.promise();
}

function waitForProceedTwoBack() {
    console.log('wait-for-proceed-2-back');
    var d = $.Deferred();
    document.getElementById("proceedTwoBackBtn").onclick = function () {
        document.getElementById('instructions-2-back').style.display = "none";
        d.resolve();
    }
    return d.promise();
}

function doNothingBuffer() {
    console.log('do-nothing-buffer');
    var d = $.Deferred();
    setTimeout(function () {
        console.log('do-nothing-buffer');
        d.resolve();
        return d.promise();
    }, 2000);
}

function completionStatus() {
    var d = $.Deferred();
    console.log('run-completed');
    alert('PVT Completed! Your CSV file has been downloaded.');
    d.resolve();
    return d.promise();
}

function returnHome() {
    console.log('return-home');
    var d = $.Deferred();
    document.getElementById("input_form").style.display = "block";
    document.getElementById("theHead").style.display = "block";
    document.getElementById("subjectiveForm").style.display = "none";
    d.resolve();
    return d.promise();
}

</script>

</html>
